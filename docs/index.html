<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>YsongCao's Sitemap</title>
  <link rel="stylesheet" href="static/css/styles.css">
</head>

<body>

  <!--抬头-->
  <div class="header-container">
    <h1 class="site-title">YsongCao's Sitemap</h1>
    <!-- 新增切换按钮 -->
    <button class="theme-toggle" id="themeToggle">暗黑模式</button>
  </div>

  <!--搜索框-->
  <div class="search-container" id="search-container">
    <form action="" method="get" class="searchForm" id="searchForm">
      <select name="engine" id="engineSelect">
        <option value="https://www.bing.com/search?q=">Bing</option>
        <option value="https://www.baidu.com/s?wd=">Baidu</option>
        <option value="https://xiaoyi.huawei.com/?q=">XiaoYi</option>
      </select>
      <input type="text" name="query" placeholder="Searching......" />
      <!--<input type="submit" value="搜索" />-->
    </form>
  </div>

  <!-- 在container内添加控制栏 （!已经隐藏但仍起作用!）-->
  <div class="container">
    <!-- 已经隐藏但仍起作用-->
    <div class="controls">
      <label>每行显示数量：</label>
      <input type="number" id="columnCount" min="1" max="14" value="4">
    </div>

    <!--快捷方式部分-->
    <div id="content-container" class="grid-container"></div>
  </div>

  <!--底栏部分-->
  <div class="tabs-container" id="tabsContainer">

    <script>

      // 搜索功能
      document.getElementById("searchForm").onsubmit = function () {
        var engine = document.getElementById("engineSelect").value;
        var query = document.querySelector('input[name="query"]').value; //  局部变量
        window.location.href = engine + encodeURIComponent(query);
        return false;
      }
      // 添加键盘回车支持
      document.querySelector('input[name="query"]').addEventListener("keypress", function (e) { //  直接获取元素
        if (e.key === "Enter") {
          document.getElementById("searchForm").dispatchEvent(new Event("submit")); //  显式获取表单
        }
      });
      // 添加输入框自动聚焦
      window.onload = function () {
        document.querySelector('input[name="query"]').focus(); //  直接获取元素
      }

      /*开始--暗黑模式部分*/
      // 新增暗黑模式切换功能
      const themeToggle = document.getElementById('themeToggle');
      // 从本地存储加载主题设置
      function loadTheme() {
        const isDark = localStorage.getItem('theme') === 'dark';
        document.body.classList.toggle('dark-mode', isDark);
        themeToggle.textContent = isDark ? '亮色模式' : '暗黑模式';
      }
      // 切换主题并保存设置
      function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        themeToggle.textContent = isDark ? '亮色模式' : '暗黑模式';
      }
      // 初始化主题设置
      loadTheme();
      themeToggle.addEventListener('click', toggleTheme);
      /*结束--暗黑模式部分*/

      // 列表展示
      /* 新增设备检测函数 */
      function isMobile() {
        return window.innerWidth <= 1100;
      }

      // 列表展示
      const columnControl = document.getElementById('columnCount');
      const gridContainer = document.getElementById('content-container');
      const columnBaseWidth = 200; // 单列基准宽度

      /* 初始列数设置 */
      const calculateColumns = () => {
        return Math.min(8, Math.max(1, Math.floor(window.innerWidth / columnBaseWidth)));
      };
      columnControl.value = calculateColumns(); // 统一调用

      // 事件监听（新增resize时的列数调整）
      columnControl.addEventListener('input', updateColumns);
      columnControl.addEventListener('change', updateColumns);

      // 优化后的防抖resize处理
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          /* 根据当前设备类型调整列数 */
          if (isMobile()) {
            columnControl.value = Math.min(8, Math.max(1, Math.floor(window.innerWidth / columnBaseWidth)
            ));  // 手机默认4列
          } else {
            columnControl.value = Math.min(8, Math.max(1, Math.floor(window.innerWidth / columnBaseWidth)
            ));  // 电脑默认8列
          }
          updateColumns();
        }, 200);
      });

      function updateColumns() {
        const count = parseInt(columnControl.value);
        const containerWidth = gridContainer.offsetWidth;
        // 动态计算卡片宽度
        const gapTotal = 20 * (count - 1);
        const cardWidth = Math.max(20, (containerWidth - gapTotal) / count);
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.gridTemplateColumns = `repeat(${count}, minmax(${cardWidth}px, 1fr))`;
        });
      }

      // 数据加载逻辑
      fetch('data.json')
        .then(response => response.json())
        .then(data => {
          const tabscontainer = document.getElementById('tabsContainer');
          const contentcontainer = document.getElementById('content-container');

          // 清空容器
          contentcontainer.innerHTML = '';
          tabscontainer.innerHTML = '';

          // 创建内容容器
          const wrapper = document.createElement('div');
          wrapper.className = 'content-wrapper';
          contentcontainer.appendChild(wrapper);

          // 使用文档片段减少DOM操作
          const tabFragment = document.createDocumentFragment();
          const contentFragment = document.createDocumentFragment();

          data.forEach((category, index) => {
            // 创建页签按钮
            const tabBtn = document.createElement('button');
            tabBtn.className = `tab-button${index === 0 ? ' active' : ''}`;
            tabBtn.textContent = category.name;
            tabBtn.dataset.tabIndex = index; // 显式绑定索引
            tabBtn.addEventListener('click', () => switchTab(index));
            tabFragment.appendChild(tabBtn);

            // 创建内容区
            const tabContent = document.createElement('div');
            tabContent.className = `tab-content${index === 0 ? ' active' : ''}`;

            // 使用map+join优化字符串拼接
            const cardsHTML = category.children.map(item => `
              <div class="card">
                  <a href="${item.target}" target="_blank" aria-label="${item.name}">
                      <img src="${item.bgImage}" alt="${item.name}" loading="lazy">
                      <h5>${item.name.slice(0, 8)}</h5>
                  </a>
              </div>
              `).join('');

            tabContent.innerHTML = cardsHTML; // 一次性插入
            contentFragment.appendChild(tabContent);
          });

          // 批量插入DOM元素
          tabscontainer.append(tabFragment);
          wrapper.append(contentFragment);

          // 初始化列数
          updateColumns();

          // 页签切换函数
          function switchTab(index) {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach((tab, i) => {
              tab.classList.toggle('active', i === index);
            });
            contents.forEach((content, i) => {
              content.classList.toggle('active', i === index);
            });
            updateColumns();
          }
        })
        .catch(error => console.error('数据加载失败:', error));

    </script>
</body>

</html>